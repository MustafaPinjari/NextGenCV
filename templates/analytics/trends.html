{% extends 'base.html' %}

{% block title %}Score Trends - Analytics - ATS Resume Builder{% endblock %}

{% block extra_css %}
<style>
.trends-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-box {
    background-color: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.stat-box-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.stat-box-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

.stat-box-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-box-change {
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 5px;
}

.stat-box-change.positive {
    color: #28a745;
}

.stat-box-change.negative {
    color: #dc3545;
}

.stat-box-change.neutral {
    color: #6c757d;
}

.chart-container {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.chart-title {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 20px;
    color: #495057;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.trend-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.trend-badge.improving {
    background-color: #d4edda;
    color: #155724;
}

.trend-badge.declining {
    background-color: #f8d7da;
    color: #721c24;
}

.trend-badge.stable {
    background-color: #d1ecf1;
    color: #0c5460;
}

.analysis-timeline {
    background-color: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.timeline-item {
    position: relative;
    padding-left: 40px;
    padding-bottom: 30px;
    border-left: 2px solid #e9ecef;
}

.timeline-item:last-child {
    border-left-color: transparent;
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -9px;
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #667eea;
    border: 3px solid white;
    box-shadow: 0 0 0 2px #667eea;
}

.timeline-content {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    transition: background-color 0.2s;
}

.timeline-content:hover {
    background-color: #e9ecef;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.timeline-resume-title {
    font-weight: 600;
    color: #495057;
}

.timeline-timestamp {
    font-size: 0.85rem;
    color: #6c757d;
}

.timeline-score {
    font-size: 1.5rem;
    font-weight: bold;
    color: #667eea;
}

.component-scores {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.component-score-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
}

.component-score-label {
    color: #6c757d;
}

.component-score-value {
    font-weight: 600;
    color: #495057;
}

.moving-average-info {
    background-color: #e7f3ff;
    border-left: 4px solid #0066cc;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.moving-average-info h6 {
    color: #0066cc;
    margin-bottom: 10px;
}

.moving-average-info p {
    margin-bottom: 0;
    color: #495057;
    font-size: 0.9rem;
}

.improvement-rate-box {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin-bottom: 30px;
}

.improvement-rate-box.negative {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.improvement-rate-box.neutral {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
}

.improvement-rate-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 10px 0;
}

.improvement-rate-label {
    font-size: 1.1rem;
    opacity: 0.9;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.empty-state-icon {
    font-size: 4rem;
    color: #6c757d;
    margin-bottom: 20px;
}

.empty-state-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
}

.empty-state-text {
    color: #6c757d;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .trends-header {
        padding: 20px;
    }
    
    .stats-summary {
        grid-template-columns: 1fr;
    }
    
    .component-scores {
        grid-template-columns: 1fr;
    }
    
    .chart-title {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Trends Header -->
        <div class="trends-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        <i class="bi bi-graph-up-arrow"></i> Score Trends Analysis
                    </h2>
                    <p class="mb-0 opacity-75">
                        Track your ATS score improvements over time with detailed component breakdowns
                    </p>
                </div>
                <a href="{% url 'analytics_dashboard' %}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
        
        {% if not has_analyses %}
        <!-- Empty State -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <h3 class="empty-state-title">{{ message }}</h3>
            <p class="empty-state-text">
                Analyze your resume with a job description to start tracking your score trends.
            </p>
            <a href="{% url 'resume_list' %}" class="btn btn-primary btn-lg">
                <i class="bi bi-list"></i> View Resumes
            </a>
        </div>
        {% else %}
        
        <!-- Stats Summary -->
        <div class="stats-summary">
            <div class="stat-box">
                <div class="stat-box-icon text-primary">
                    <i class="bi bi-bar-chart"></i>
                </div>
                <div class="stat-box-value text-primary">{{ total_analyses }}</div>
                <div class="stat-box-label">Total Analyses</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-box-icon text-info">
                    <i class="bi bi-speedometer2"></i>
                </div>
                <div class="stat-box-value text-info">{{ first_score }}</div>
                <div class="stat-box-label">First Score</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-box-icon text-success">
                    <i class="bi bi-trophy"></i>
                </div>
                <div class="stat-box-value text-success">{{ latest_score }}</div>
                <div class="stat-box-label">Latest Score</div>
            </div>
            
            <div class="stat-box">
                <div class="stat-box-icon {% if total_improvement >= 0 %}text-success{% else %}text-danger{% endif %}">
                    <i class="bi bi-arrow-{% if total_improvement >= 0 %}up{% else %}down{% endif %}-circle"></i>
                </div>
                <div class="stat-box-value {% if total_improvement >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if total_improvement > 0 %}+{% endif %}{{ total_improvement }}
                </div>
                <div class="stat-box-label">Total Improvement</div>
                <div class="stat-box-change {% if total_improvement > 0 %}positive{% elif total_improvement < 0 %}negative{% else %}neutral{% endif %}">
                    {% if total_improvement > 0 %}
                        <i class="bi bi-arrow-up"></i> Improving
                    {% elif total_improvement < 0 %}
                        <i class="bi bi-arrow-down"></i> Declining
                    {% else %}
                        <i class="bi bi-dash"></i> Stable
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Improvement Rate -->
        <div class="improvement-rate-box {% if improvement_rate < 0 %}negative{% elif improvement_rate == 0 %}neutral{% endif %}">
            <div class="improvement-rate-label">Average Improvement Rate</div>
            <div class="improvement-rate-value">
                {% if improvement_rate > 0 %}+{% endif %}{{ improvement_rate|floatformat:2 }}
                <small style="font-size: 1rem;">points per analysis</small>
            </div>
            <p class="mb-0 opacity-75">
                {% if improvement_rate > 0 %}
                    <i class="bi bi-emoji-smile"></i> Your scores are consistently improving!
                {% elif improvement_rate < 0 %}
                    <i class="bi bi-emoji-frown"></i> Your scores are declining. Review recommendations.
                {% else %}
                    <i class="bi bi-emoji-neutral"></i> Your scores are stable.
                {% endif %}
            </p>
        </div>
        
        <!-- Moving Average Info -->
        <div class="moving-average-info">
            <h6><i class="bi bi-info-circle"></i> About Moving Average</h6>
            <p>
                The moving average smooths out short-term fluctuations to show the overall trend direction. 
                It's calculated using a 5-analysis window to help you see patterns more clearly.
            </p>
        </div>
        
        <!-- Overall Trend Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <span>
                    <i class="bi bi-graph-up"></i> Overall Score Trend
                </span>
                <span class="trend-badge {{ trend_direction }}">
                    <i class="bi bi-arrow-{% if trend_direction == 'improving' %}up{% elif trend_direction == 'declining' %}down{% else %}right{% endif %}"></i>
                    {{ trend_direction|title }}
                </span>
            </div>
            <canvas id="overallTrendChart" height="80"></canvas>
        </div>
        
        <!-- Component Trends Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <span>
                    <i class="bi bi-layers"></i> Component Score Trends
                </span>
            </div>
            <p class="text-muted small mb-3">
                Track how each scoring component has changed over time
            </p>
            <canvas id="componentTrendsChart" height="100"></canvas>
        </div>
        
        <!-- Analysis Timeline -->
        <div class="analysis-timeline">
            <h5 class="mb-4">
                <i class="bi bi-clock-history"></i> Analysis History
            </h5>
            {% for analysis in analysis_data %}
            <div class="timeline-item">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                    <div class="timeline-header">
                        <div>
                            <div class="timeline-resume-title">{{ analysis.resume_title }}</div>
                            <div class="timeline-timestamp">
                                <i class="bi bi-calendar"></i> {{ analysis.timestamp_display }}
                            </div>
                        </div>
                        <div class="timeline-score">{{ analysis.final_score|floatformat:1 }}</div>
                    </div>
                    <div class="component-scores">
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-key"></i> Keywords
                            </span>
                            <span class="component-score-value">{{ analysis.keyword_match_score|floatformat:1 }}</span>
                        </div>
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-tools"></i> Skills
                            </span>
                            <span class="component-score-value">{{ analysis.skill_relevance_score|floatformat:1 }}</span>
                        </div>
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-list-check"></i> Sections
                            </span>
                            <span class="component-score-value">{{ analysis.section_completeness_score|floatformat:1 }}</span>
                        </div>
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-briefcase"></i> Experience
                            </span>
                            <span class="component-score-value">{{ analysis.experience_impact_score|floatformat:1 }}</span>
                        </div>
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-123"></i> Metrics
                            </span>
                            <span class="component-score-value">{{ analysis.quantification_score|floatformat:1 }}</span>
                        </div>
                        <div class="component-score-item">
                            <span class="component-score-label">
                                <i class="bi bi-pencil"></i> Verbs
                            </span>
                            <span class="component-score-value">{{ analysis.action_verb_score|floatformat:1 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Action Buttons -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <a href="{% url 'analytics_dashboard' %}" class="btn btn-outline-primary btn-lg w-100">
                    <i class="bi bi-speedometer2"></i> Back to Dashboard
                </a>
            </div>
            <div class="col-md-6 mb-3">
                <a href="{% url 'improvement_report' %}" class="btn btn-outline-success btn-lg w-100">
                    <i class="bi bi-file-earmark-text"></i> View Improvement Report
                </a>
            </div>
        </div>
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if has_analyses %}
    // Parse chart data from context
    const chartData = {{ chart_data_json|safe }};
    
    // Overall Trend Chart
    if (chartData.overall_trend && chartData.overall_trend.labels.length > 0) {
        const overallTrendCtx = document.getElementById('overallTrendChart').getContext('2d');
        new Chart(overallTrendCtx, {
            type: 'line',
            data: {
                labels: chartData.overall_trend.labels,
                datasets: [
                    {
                        label: 'ATS Score',
                        data: chartData.overall_trend.scores,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: 'rgb(102, 126, 234)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'Moving Average (5-period)',
                        data: chartData.overall_trend.moving_average,
                        borderColor: 'rgb(118, 75, 162)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(118, 75, 162)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'ATS Score',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Analysis Date',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Component Trends Chart
    if (chartData.component_trends && chartData.component_trends.labels.length > 0) {
        const componentTrendsCtx = document.getElementById('componentTrendsChart').getContext('2d');
        new Chart(componentTrendsCtx, {
            type: 'line',
            data: {
                labels: chartData.component_trends.labels,
                datasets: chartData.component_trends.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Component Score',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Analysis Date',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
