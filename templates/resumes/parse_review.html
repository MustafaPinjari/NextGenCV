{% extends 'base.html' %}

{% block title %}Review Parsed Resume - ATS Resume Builder{% endblock %}

{% block extra_css %}
<style>
    .confidence-badge {
        font-size: 1rem;
        padding: 8px 16px;
    }
    
    .confidence-high {
        background-color: #198754;
    }
    
    .confidence-medium {
        background-color: #ffc107;
        color: #000;
    }
    
    .confidence-low {
        background-color: #dc3545;
    }
    
    .section-card {
        border-left: 4px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .section-card.high-confidence {
        border-left-color: #198754;
    }
    
    .section-card.medium-confidence {
        border-left-color: #ffc107;
    }
    
    .section-card.low-confidence {
        border-left-color: #dc3545;
    }
    
    .section-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .editable-field {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px 12px;
        transition: all 0.2s ease;
    }
    
    .editable-field:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        outline: 0;
    }
    
    .confidence-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .confidence-indicator.high {
        background-color: #198754;
    }
    
    .confidence-indicator.medium {
        background-color: #ffc107;
    }
    
    .confidence-indicator.low {
        background-color: #dc3545;
    }
    
    .parsing-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .empty-section {
        background-color: #fff3cd;
        border: 1px dashed #ffc107;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        color: #856404;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .array-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    
    .array-item-remove {
        position: absolute;
        top: 10px;
        right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Review Parsed Resume</h2>
            <a href="{% url 'pdf_upload' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Upload Different File
            </a>
        </div>
        
        <!-- Parsing Confidence Overview -->
        <div class="parsing-stats mb-4">
            <div class="row">
                <div class="col-md-3 stat-item">
                    <span class="stat-value">{{ confidence_percent }}%</span>
                    <span class="stat-label">Overall Confidence</span>
                </div>
                <div class="col-md-3 stat-item">
                    <span class="stat-value">{% if personal_info %}1{% else %}0{% endif %}{% if experiences %}+{{ experiences|length }}{% endif %}{% if education %}+{{ education|length }}{% endif %}{% if skills %}+{{ skills|length }}{% endif %}</span>
                    <span class="stat-label">Sections Found</span>
                </div>
                <div class="col-md-3 stat-item">
                    <span class="stat-value">{{ uploaded_resume.file_size|filesizeformat }}</span>
                    <span class="stat-label">File Size</span>
                </div>
                <div class="col-md-3 stat-item">
                    <span class="stat-value">{{ uploaded_resume.uploaded_at|date:"M d, Y" }}</span>
                    <span class="stat-label">Upload Date</span>
                </div>
            </div>
        </div>
        
        <!-- Confidence Alert -->
        {% if confidence < 0.7 %}
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Low Parsing Confidence:</strong> We had some difficulty parsing your resume. 
            Please carefully review the extracted information below and make any necessary corrections.
        </div>
        {% elif confidence < 0.85 %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Medium Parsing Confidence:</strong> Most of your resume was parsed successfully. 
            Please review the highlighted sections for accuracy.
        </div>
        {% else %}
        <div class="alert alert-success" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>High Parsing Confidence:</strong> Your resume was parsed successfully! 
            Please review the information below and make any adjustments if needed.
        </div>
        {% endif %}
        
        <!-- Instructions -->
        <div class="card mb-4 border-info">
            <div class="card-body">
                <h6 class="card-title text-info">
                    <i class="bi bi-lightbulb"></i> Instructions
                </h6>
                <ul class="mb-0 small">
                    <li>Review all extracted information for accuracy</li>
                    <li>Sections with <span class="confidence-indicator low"></span> low confidence may need corrections</li>
                    <li>Click on any field to edit it inline</li>
                    <li>Add missing information or remove incorrect entries</li>
                    <li>Click "Confirm and Import" when you're satisfied with the data</li>
                </ul>
            </div>
        </div>
        
        <!-- Review Form -->
        <form method="post" id="reviewForm">
            {% csrf_token %}
            
            <!-- Personal Information Section -->
            <div class="card section-card mb-4 {% if confidence >= 0.85 %}high-confidence{% elif confidence >= 0.70 %}medium-confidence{% else %}low-confidence{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="confidence-indicator {% if confidence >= 0.85 %}high{% elif confidence >= 0.70 %}medium{% else %}low{% endif %}"></span>
                        Personal Information
                    </h5>
                    <span class="badge confidence-badge {% if confidence >= 0.85 %}confidence-high{% elif confidence >= 0.70 %}confidence-medium{% else %}confidence-low{% endif %}">
                        {{ confidence_percent }}% Confidence
                    </span>
                </div>
                <div class="card-body">
                    {% if personal_info %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" 
                                   class="form-control editable-field" 
                                   name="full_name" 
                                   value="{{ personal_info.full_name|default:'' }}"
                                   required>
                            <div class="help-text">Your complete name as it should appear on the resume</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" 
                                   class="form-control editable-field" 
                                   name="email" 
                                   value="{{ personal_info.email|default:'' }}"
                                   required>
                            <div class="help-text">Professional email address</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" 
                                   class="form-control editable-field" 
                                   name="phone" 
                                   value="{{ personal_info.phone|default:'' }}">
                            <div class="help-text">Contact phone number</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" 
                                   class="form-control editable-field" 
                                   name="location" 
                                   value="{{ personal_info.location|default:'' }}">
                            <div class="help-text">City, State or City, Country</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">LinkedIn URL</label>
                            <input type="url" 
                                   class="form-control editable-field" 
                                   name="linkedin" 
                                   value="{{ personal_info.linkedin|default:'' }}">
                            <div class="help-text">Your LinkedIn profile URL</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">GitHub URL</label>
                            <input type="url" 
                                   class="form-control editable-field" 
                                   name="github" 
                                   value="{{ personal_info.github|default:'' }}">
                            <div class="help-text">Your GitHub profile URL</div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-section">
                        <i class="bi bi-exclamation-circle fs-3 mb-2"></i>
                        <p class="mb-0">No personal information was detected. Please fill in your details manually.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Work Experience Section -->
            <div class="card section-card mb-4 {% if confidence >= 0.85 %}high-confidence{% elif confidence >= 0.70 %}medium-confidence{% else %}low-confidence{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="confidence-indicator {% if confidence >= 0.85 %}high{% elif confidence >= 0.70 %}medium{% else %}low{% endif %}"></span>
                        Work Experience
                    </h5>
                    <span class="badge confidence-badge {% if confidence >= 0.85 %}confidence-high{% elif confidence >= 0.70 %}confidence-medium{% else %}confidence-low{% endif %}">
                        {{ confidence_percent }}% Confidence
                    </span>
                </div>
                <div class="card-body">
                    <div id="experiencesContainer">
                        {% if experiences %}
                            {% for exp in experiences %}
                            <div class="array-item" data-index="{{ forloop.counter0 }}">
                                <button type="button" class="btn btn-sm btn-outline-danger array-item-remove" onclick="removeArrayItem(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Company *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="experiences[{{ forloop.counter0 }}][company]" 
                                               value="{{ exp.company|default:'' }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Role/Title *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="experiences[{{ forloop.counter0 }}][role]" 
                                               value="{{ exp.role|default:'' }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Start Date *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="experiences[{{ forloop.counter0 }}][start_date]" 
                                               value="{{ exp.start_date|default:'' }}"
                                               placeholder="MM/YYYY"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">End Date</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="experiences[{{ forloop.counter0 }}][end_date]" 
                                               value="{{ exp.end_date|default:'' }}"
                                               placeholder="MM/YYYY or leave blank if current">
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label class="form-label">Description *</label>
                                        <textarea class="form-control editable-field" 
                                                  name="experiences[{{ forloop.counter0 }}][description]" 
                                                  rows="4"
                                                  required>{{ exp.description|default:'' }}</textarea>
                                        <div class="help-text">Bullet points describing your responsibilities and achievements</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-section">
                            <i class="bi bi-briefcase fs-3 mb-2"></i>
                            <p class="mb-0">No work experience was detected. You can add entries manually after import.</p>
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="addExperience()">
                        <i class="bi bi-plus-circle"></i> Add Experience
                    </button>
                </div>
            </div>
            
            <!-- Education Section -->
            <div class="card section-card mb-4 {% if confidence >= 0.85 %}high-confidence{% elif confidence >= 0.70 %}medium-confidence{% else %}low-confidence{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="confidence-indicator {% if confidence >= 0.85 %}high{% elif confidence >= 0.70 %}medium{% else %}low{% endif %}"></span>
                        Education
                    </h5>
                    <span class="badge confidence-badge {% if confidence >= 0.85 %}confidence-high{% elif confidence >= 0.70 %}confidence-medium{% else %}confidence-low{% endif %}">
                        {{ confidence_percent }}% Confidence
                    </span>
                </div>
                <div class="card-body">
                    <div id="educationContainer">
                        {% if education %}
                            {% for edu in education %}
                            <div class="array-item" data-index="{{ forloop.counter0 }}">
                                <button type="button" class="btn btn-sm btn-outline-danger array-item-remove" onclick="removeArrayItem(this)">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Institution *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="education[{{ forloop.counter0 }}][institution]" 
                                               value="{{ edu.institution|default:'' }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Degree *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="education[{{ forloop.counter0 }}][degree]" 
                                               value="{{ edu.degree|default:'' }}"
                                               required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Field of Study *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="education[{{ forloop.counter0 }}][field]" 
                                               value="{{ edu.field|default:'' }}"
                                               required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Start Year *</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="education[{{ forloop.counter0 }}][start_year]" 
                                               value="{{ edu.start_year|default:'' }}"
                                               placeholder="YYYY"
                                               required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">End Year</label>
                                        <input type="text" 
                                               class="form-control editable-field" 
                                               name="education[{{ forloop.counter0 }}][end_year]" 
                                               value="{{ edu.end_year|default:'' }}"
                                               placeholder="YYYY">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-section">
                            <i class="bi bi-mortarboard fs-3 mb-2"></i>
                            <p class="mb-0">No education was detected. You can add entries manually after import.</p>
                        </div>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="addEducation()">
                        <i class="bi bi-plus-circle"></i> Add Education
                    </button>
                </div>
            </div>
            
            <!-- Skills Section -->
            <div class="card section-card mb-4 {% if confidence >= 0.85 %}high-confidence{% elif confidence >= 0.70 %}medium-confidence{% else %}low-confidence{% endif %}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="confidence-indicator {% if confidence >= 0.85 %}high{% elif confidence >= 0.70 %}medium{% else %}low{% endif %}"></span>
                        Skills
                    </h5>
                    <span class="badge confidence-badge {% if confidence >= 0.85 %}confidence-high{% elif confidence >= 0.70 %}confidence-medium{% else %}confidence-low{% endif %}">
                        {{ confidence_percent }}% Confidence
                    </span>
                </div>
                <div class="card-body">
                    {% if skills %}
                    <div class="mb-3">
                        <label class="form-label">Extracted Skills (comma-separated)</label>
                        <textarea class="form-control editable-field" 
                                  name="skills" 
                                  rows="4">{% for skill in skills %}{{ skill.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</textarea>
                        <div class="help-text">Edit, add, or remove skills as needed. Separate with commas.</div>
                    </div>
                    {% else %}
                    <div class="empty-section">
                        <i class="bi bi-gear fs-3 mb-2"></i>
                        <p class="mb-0">No skills were detected. You can add them manually after import.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'pdf_upload' %}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Confirm and Import Resume
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let experienceCounter = {{ experiences|length|default:0 }};
    let educationCounter = {{ education|length|default:0 }};
    
    // Add new experience entry
    function addExperience() {
        const container = document.getElementById('experiencesContainer');
        const emptySection = container.querySelector('.empty-section');
        if (emptySection) {
            emptySection.remove();
        }
        
        const newItem = document.createElement('div');
        newItem.className = 'array-item';
        newItem.setAttribute('data-index', experienceCounter);
        newItem.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-danger array-item-remove" onclick="removeArrayItem(this)">
                <i class="bi bi-trash"></i>
            </button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Company *</label>
                    <input type="text" class="form-control editable-field" name="experiences[${experienceCounter}][company]" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Role/Title *</label>
                    <input type="text" class="form-control editable-field" name="experiences[${experienceCounter}][role]" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Start Date *</label>
                    <input type="text" class="form-control editable-field" name="experiences[${experienceCounter}][start_date]" placeholder="MM/YYYY" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">End Date</label>
                    <input type="text" class="form-control editable-field" name="experiences[${experienceCounter}][end_date]" placeholder="MM/YYYY or leave blank if current">
                </div>
                <div class="col-12 mb-3">
                    <label class="form-label">Description *</label>
                    <textarea class="form-control editable-field" name="experiences[${experienceCounter}][description]" rows="4" required></textarea>
                    <div class="help-text">Bullet points describing your responsibilities and achievements</div>
                </div>
            </div>
        `;
        container.appendChild(newItem);
        experienceCounter++;
    }
    
    // Add new education entry
    function addEducation() {
        const container = document.getElementById('educationContainer');
        const emptySection = container.querySelector('.empty-section');
        if (emptySection) {
            emptySection.remove();
        }
        
        const newItem = document.createElement('div');
        newItem.className = 'array-item';
        newItem.setAttribute('data-index', educationCounter);
        newItem.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-danger array-item-remove" onclick="removeArrayItem(this)">
                <i class="bi bi-trash"></i>
            </button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Institution *</label>
                    <input type="text" class="form-control editable-field" name="education[${educationCounter}][institution]" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Degree *</label>
                    <input type="text" class="form-control editable-field" name="education[${educationCounter}][degree]" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Field of Study *</label>
                    <input type="text" class="form-control editable-field" name="education[${educationCounter}][field]" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Start Year *</label>
                    <input type="text" class="form-control editable-field" name="education[${educationCounter}][start_year]" placeholder="YYYY" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">End Year</label>
                    <input type="text" class="form-control editable-field" name="education[${educationCounter}][end_year]" placeholder="YYYY">
                </div>
            </div>
        `;
        container.appendChild(newItem);
        educationCounter++;
    }
    
    // Remove array item
    function removeArrayItem(button) {
        if (confirm('Are you sure you want to remove this entry?')) {
            button.closest('.array-item').remove();
        }
    }
    
    // Form validation before submit
    document.getElementById('reviewForm').addEventListener('submit', function(e) {
        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields marked with *');
        }
    });
    
    // Auto-save to localStorage on input change
    const form = document.getElementById('reviewForm');
    const formInputs = form.querySelectorAll('input, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('change', () => {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            localStorage.setItem('resume_parse_review', JSON.stringify(data));
        });
    });
    
    // Restore from localStorage on page load
    window.addEventListener('load', () => {
        const savedData = localStorage.getItem('resume_parse_review');
        if (savedData) {
            const data = JSON.parse(savedData);
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input && !input.value) {
                    input.value = data[key];
                }
            });
        }
    });
    
    // Clear localStorage on successful submit
    form.addEventListener('submit', () => {
        localStorage.removeItem('resume_parse_review');
    });
</script>
{% endblock %}
