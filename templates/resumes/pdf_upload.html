{% extends 'layouts/authenticated.html' %}
{% load static %}

{% block title %}Upload Resume PDF - NextGenCV{% endblock %}

{% block extra_css %}
<style>
    /* ============================================ */
    /* PDF Upload Page Styles */
    /* ============================================ */
    
    /* Page Header */
    .upload-page-header {
        margin-bottom: 2rem;
    }
    
    .upload-page-title {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--color-text-primary, #f5f5f5);
        margin-bottom: 0.5rem;
    }
    
    .upload-page-subtitle {
        font-size: 1.125rem;
        color: var(--color-text-secondary, #a3a3a3);
    }
    
    /* Upload Zone */
    .upload-zone {
        position: relative;
        border: 3px dashed var(--color-border, rgba(255, 255, 255, 0.08));
        border-radius: 1.25rem;
        padding: 4rem 2rem;
        text-align: center;
        background: var(--color-surface, #141414);
        transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        min-height: 320px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .upload-zone:hover {
        border-color: var(--color-primary-solid, #0066ff);
        background: var(--color-surface-elevated, #1a1a1a);
        box-shadow: 0 0 20px rgba(0, 102, 255, 0.2);
    }
    
    .upload-zone.dragover {
        border-color: var(--color-primary-solid, #0066ff);
        background: var(--color-surface-elevated, #1a1a1a);
        box-shadow: 0 0 30px rgba(0, 102, 255, 0.4);
        transform: scale(1.01);
        border-width: 4px;
    }
    
    .upload-icon {
        font-size: 4rem;
        color: var(--color-text-secondary, #a3a3a3);
        margin-bottom: 1.5rem;
        transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .upload-zone:hover .upload-icon,
    .upload-zone.dragover .upload-icon {
        color: var(--color-primary-solid, #0066ff);
        transform: scale(1.1);
    }
    
    .upload-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--color-text-primary, #f5f5f5);
        margin-bottom: 0.5rem;
    }
    
    .upload-subtitle {
        font-size: 1rem;
        color: var(--color-text-secondary, #a3a3a3);
        margin-bottom: 1.5rem;
    }
    
    .file-input-hidden {
        display: none;
    }
    
    /* File Info Display */
    .file-info-card {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: var(--color-surface-elevated, #1a1a1a);
        border: 1px solid var(--color-border, rgba(255, 255, 255, 0.08));
        border-radius: 1rem;
        display: none;
        animation: slideIn 250ms ease-out;
    }
    
    .file-info-card.show {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .file-info-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .file-icon {
        font-size: 2.5rem;
        color: var(--color-error, #ef4444);
    }
    
    .file-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .file-name {
        font-weight: 600;
        color: var(--color-text-primary, #f5f5f5);
        font-size: 1rem;
    }
    
    .file-size {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #a3a3a3);
    }
    
    /* Progress Container */
    .progress-container {
        margin-top: 2rem;
        display: none;
        animation: slideIn 250ms ease-out;
    }
    
    .progress-container.show {
        display: block;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .progress-text {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #a3a3a3);
    }
    
    .progress-percentage {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-primary-solid, #0066ff);
    }
    
    .progress-bar-container {
        height: 12px;
        background: var(--color-surface-elevated, #1a1a1a);
        border-radius: 9999px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(135deg, #0066ff 0%, #00ccff 100%);
        border-radius: 9999px;
        transition: width 250ms cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 0 12px rgba(0, 102, 255, 0.5);
    }
    
    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.3),
            transparent
        );
        animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
        0% {
            transform: translateX(-100%);
        }
        100% {
            transform: translateX(100%);
        }
    }
    
    /* Results Section */
    .results-section {
        margin-top: 3rem;
        display: none;
        animation: fadeIn 500ms ease-out;
    }
    
    .results-section.show {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    .results-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .results-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: var(--color-text-primary, #f5f5f5);
        margin-bottom: 0.5rem;
    }
    
    /* Score Reveal */
    .score-reveal {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }
    
    .score-circle {
        position: relative;
        width: 160px;
        height: 160px;
    }
    
    .score-circle svg {
        transform: rotate(-90deg);
    }
    
    .score-circle-bg {
        fill: none;
        stroke: var(--color-surface-elevated, #1a1a1a);
        stroke-width: 8;
    }
    
    .score-circle-bar {
        fill: none;
        stroke: url(#score-gradient);
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .score-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .score-value {
        font-size: 3rem;
        font-weight: 700;
        color: var(--color-text-primary, #f5f5f5);
        line-height: 1;
    }
    
    .score-label {
        font-size: 0.875rem;
        color: var(--color-text-secondary, #a3a3a3);
        margin-top: 0.5rem;
    }
    
    /* Keywords Section */
    .keywords-section {
        margin-bottom: 2rem;
    }
    
    .keywords-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary, #f5f5f5);
        margin-bottom: 1rem;
    }
    
    .keywords-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    
    .keyword-tag {
        padding: 0.5rem 1rem;
        background: var(--color-surface-elevated, #1a1a1a);
        border: 1px solid var(--color-border, rgba(255, 255, 255, 0.08));
        border-radius: 9999px;
        color: var(--color-text-primary, #f5f5f5);
        font-size: 0.875rem;
        transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .keyword-tag:hover {
        border-color: var(--color-primary-solid, #0066ff);
        box-shadow: 0 0 12px rgba(0, 102, 255, 0.3);
    }
    
    /* CTA Section */
    .cta-section {
        text-align: center;
    }
    
    /* Instructions Card */
    .instructions-card {
        background: var(--color-surface, #141414);
        border: 1px solid var(--color-border, rgba(255, 255, 255, 0.08));
        border-radius: 1.25rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .instructions-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--color-text-primary, #f5f5f5);
        margin-bottom: 1rem;
    }
    
    .instructions-icon {
        color: var(--color-primary-solid, #0066ff);
        font-size: 1.5rem;
    }
    
    .instructions-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .instructions-list li {
        padding-left: 1.5rem;
        margin-bottom: 0.75rem;
        color: var(--color-text-secondary, #a3a3a3);
        position: relative;
    }
    
    .instructions-list li::before {
        content: '•';
        position: absolute;
        left: 0;
        color: var(--color-primary-solid, #0066ff);
        font-weight: 700;
    }
    
    .instructions-list li:last-child {
        margin-bottom: 0;
    }
    
    /* Tips Card */
    .tips-card {
        background: var(--color-surface, #141414);
        border: 1px solid var(--color-primary-solid, #0066ff);
        border-radius: 1.25rem;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 0 20px rgba(0, 102, 255, 0.1);
    }
    
    .tips-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-primary-solid, #0066ff);
        margin-bottom: 1rem;
    }
    
    .tips-icon {
        font-size: 1.25rem;
    }
    
    .tips-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .tips-list li {
        padding-left: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--color-text-secondary, #a3a3a3);
        font-size: 0.875rem;
        position: relative;
    }
    
    .tips-list li::before {
        content: '✓';
        position: absolute;
        left: 0;
        color: var(--color-success, #10b981);
    }
    
    .tips-list li:last-child {
        margin-bottom: 0;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .upload-zone {
            padding: 3rem 1.5rem;
            min-height: 280px;
        }
        
        .upload-icon {
            font-size: 3rem;
        }
        
        .upload-title {
            font-size: 1.25rem;
        }
        
        .file-info-card {
            flex-direction: column;
            gap: 1rem;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
        }
        
        .score-value {
            font-size: 2.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-page-header">
    <h1 class="upload-page-title">Upload Resume PDF</h1>
    <p class="upload-page-subtitle">Upload your existing resume and let our AI analyze it</p>
</div>

<!-- Instructions Card -->
<div class="instructions-card">
    <h2 class="instructions-title">
        <i class="bi bi-info-circle instructions-icon"></i>
        <span>How It Works</span>
    </h2>
    <ul class="instructions-list">
        <li>Upload your existing resume in PDF format (max 10 MB)</li>
        <li>Our AI will automatically extract and parse your resume content</li>
        <li>Review the extracted information and make any necessary edits</li>
        <li>Get instant ATS score and optimization suggestions</li>
        <li>Save your resume to your dashboard for future editing</li>
    </ul>
</div>

<!-- Upload Form -->
<form method="post" enctype="multipart/form-data" id="uploadForm">
    {% csrf_token %}
    
    <!-- Drag and Drop Upload Zone -->
    <div class="upload-zone" id="uploadZone">
        <i class="bi bi-cloud-upload upload-icon"></i>
        <h3 class="upload-title">Drag & Drop your PDF here</h3>
        <p class="upload-subtitle">or</p>
        <button type="button" class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-folder2-open"></i> Browse Files
        </button>
        <input type="file" 
               name="resume_file" 
               id="fileInput" 
               class="file-input-hidden" 
               accept=".pdf,application/pdf"
               required>
    </div>
    
    <!-- File Information Display -->
    <div class="file-info-card" id="fileInfo">
        <div class="file-info-content">
            <i class="bi bi-file-earmark-pdf file-icon"></i>
            <div class="file-details">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>
        </div>
        <button type="button" class="btn btn-ghost" onclick="clearFile()">
            <i class="bi bi-x-circle"></i> Remove
        </button>
    </div>
    
    <!-- Validation Messages Container -->
    <div id="validationMessages"></div>
    
    <!-- Progress Bar -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-label">
            <span class="progress-text">Uploading and analyzing...</span>
            <span class="progress-percentage" id="progressPercentage">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
        </div>
    </div>
    
    <!-- Submit Button -->
    <div style="margin-top: 2rem; text-align: center;">
        <button type="submit" class="btn btn-gradient btn-lg" id="submitBtn" disabled>
            <i class="bi bi-upload"></i> Upload and Analyze Resume
        </button>
    </div>
</form>

<!-- Tips Card -->
<div class="tips-card">
    <h3 class="tips-title">
        <i class="bi bi-lightbulb tips-icon"></i>
        <span>Tips for Best Results</span>
    </h3>
    <ul class="tips-list">
        <li>Use a standard resume format with clear section headings</li>
        <li>Ensure your PDF has selectable text (not a scanned image)</li>
        <li>Avoid complex layouts with multiple columns</li>
        <li>Remove headers, footers, and page numbers if possible</li>
        <li>Use standard fonts and avoid decorative elements</li>
    </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // DOM Elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const submitBtn = document.getElementById('submitBtn');
    const validationMessages = document.getElementById('validationMessages');
    const uploadForm = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    
    // Constants
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
    const ALLOWED_TYPES = ['application/pdf', 'pdf'];
    
    // Drag and Drop Handlers
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    // File Input Change Handler
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Handle File Selection
    function handleFileSelect(file) {
        // Clear previous messages
        validationMessages.innerHTML = '';
        
        // Validate file type
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (!ALLOWED_TYPES.includes(file.type) && fileExtension !== 'pdf') {
            showError('Please upload a PDF file. Other file types are not supported.');
            clearFile();
            return;
        }
        
        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            showError(`File size (${sizeMB} MB) exceeds the maximum limit of 10 MB. Please upload a smaller file.`);
            clearFile();
            return;
        }
        
        // Display file information
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.add('show');
        submitBtn.disabled = false;
        
        showSuccess('File validated successfully! Ready to upload.');
    }
    
    // Clear File Selection
    function clearFile() {
        fileInput.value = '';
        fileInfo.classList.remove('show');
        submitBtn.disabled = true;
        validationMessages.innerHTML = '';
    }
    
    // Format File Size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Show Error Message
    function showError(message) {
        validationMessages.innerHTML = `
            <div class="alert alert--error" role="alert" style="margin-top: 1.5rem;">
                <div class="alert__icon">
                    <i class="bi bi-x-circle"></i>
                </div>
                <div class="alert__content">${message}</div>
            </div>
        `;
    }
    
    // Show Success Message
    function showSuccess(message) {
        validationMessages.innerHTML = `
            <div class="alert alert--success" role="alert" style="margin-top: 1.5rem;">
                <div class="alert__icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="alert__content">${message}</div>
            </div>
        `;
    }
    
    // Form Submission Handler
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner spinner-sm" style="margin-right: 0.5rem;"></span> Processing...';
        
        // Show progress bar
        progressContainer.classList.add('show');
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 90) {
                updateProgress(progress);
            }
        }, 200);
        
        // Create FormData and submit
        const formData = new FormData(uploadForm);
        
        fetch(uploadForm.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            clearInterval(progressInterval);
            updateProgress(100);
            
            if (response.ok || response.redirected) {
                // Success - redirect to review page
                setTimeout(() => {
                    window.location.href = response.url || window.location.href;
                }, 500);
            } else {
                throw new Error('Upload failed');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            progressContainer.classList.remove('show');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-upload"></i> Upload and Analyze Resume';
            showError('An error occurred while uploading. Please try again.');
            console.error('Upload error:', error);
        });
    });
    
    // Update Progress Bar
    function updateProgress(percent) {
        progressBar.style.width = percent + '%';
        progressPercentage.textContent = percent + '%';
    }
</script>
{% endblock %}
